<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026å€¼ç­è¡¨ - é™¤éŒ¯è¨ºæ–·ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --milk-tea-bg: #f8f1ed;
            --milk-tea-accent: #e6ccb2;
            --milk-tea-dark: #b08968;
            --coffee-text: #5d534a;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--milk-tea-bg); color: var(--coffee-text); padding: 20px; }
        .nordic-container { max-width: 1000px; margin: 0 auto; }
        .sync-panel { background: white; border: 2px dashed var(--milk-tea-accent); border-radius: 20px; padding: 20px; margin-bottom: 25px; }
        .url-input { border: 1px solid var(--milk-tea-accent); border-radius: 50px; padding: 10px 20px; width: 100%; max-width: 500px; outline: none; margin-bottom: 10px; }
        .btn { padding: 10px 20px; border-radius: 50px; font-weight: 500; cursor: pointer; transition: 0.3s; font-size: 0.9rem; }
        .btn-primary { background: var(--milk-tea-dark); color: white; }
        .btn-test { background: #6d8e7f; color: white; }
        .error-box { background: #fee2e2; border: 1px solid #ef4444; color: #b91c1c; padding: 15px; border-radius: 12px; margin-top: 10px; display: none; font-size: 0.85rem; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; border-radius: 20px; overflow: hidden; border: 1px solid var(--milk-tea-accent); }
        th { background: var(--milk-tea-accent); padding: 15px; border-bottom: 1px solid var(--milk-tea-dark); }
        td { padding: 12px; text-align: center; border-bottom: 1px solid var(--milk-tea-accent); border-right: 1px solid var(--milk-tea-accent); }
        .editable:focus { outline: 2px solid var(--milk-tea-dark); }
    </style>
</head>
<body>

    <div class="nordic-container">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-[#b08968]">2026 å¹´å€¼ç­è¡¨ç³»çµ±</h1>
            <p class="opacity-50 text-sm mt-2">è¨ºæ–·å·¥å…·å·²å•Ÿå‹•ï¼Œè«‹å”åŠ©å®šä½éŒ¯èª¤</p>
        </header>

        <div class="sync-panel">
            <h3 class="font-bold mb-3">ğŸ“¡ ç¬¬ä¸€æ­¥ï¼šé€£ç·šè¨­å®š</h3>
            <input type="text" id="gasUrl" class="url-input" placeholder="è²¼ä¸Š Google Script URL (ä»¥ /exec çµå°¾)" onchange="saveConfig()">
            <div class="flex gap-3">
                <button onclick="testConnection()" id="btnTest" class="btn btn-test">1. æ¸¬è©¦é€£ç·šç‹€æ…‹</button>
                <button onclick="syncFromCloud()" id="btnLoad" class="btn btn-outline border border-[#ccc]">2. å¾é›²ç«¯ä¸‹è¼‰</button>
                <button onclick="syncToCloud()" id="btnSave" class="btn btn-primary">3. å„²å­˜è‡³é›²ç«¯</button>
            </div>
            <div id="debugInfo" class="error-box"></div>
        </div>

        <div class="mb-4">
            <select id="monthSelect" class="p-2 border rounded-full bg-white text-sm" onchange="changeMonth(this.value)">
                <!-- JS æœƒå¡«å…¥æœˆä»½ -->
            </select>
        </div>

        <table>
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>æ˜ŸæœŸ</th>
                    <th>é–‹åº—</th>
                    <th>å€¼ç­</th>
                    <th>20:00</th>
                    <th>é—œå¸³</th>
                </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
        </table>
    </div>

    <script>
        const storageKey = 'nordic_shift_full_v4';
        let currentMonth = new Date().getMonth();
        let fullYearData = JSON.parse(localStorage.getItem(storageKey)) || {};

        function init() {
            const select = document.getElementById('monthSelect');
            for(let i=0; i<12; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = (i+1) + "æœˆ";
                select.appendChild(opt);
            }
            select.value = currentMonth;
            document.getElementById('gasUrl').value = localStorage.getItem('gas_url') || '';
            renderTable();
        }

        function renderTable() {
            const body = document.getElementById('scheduleBody');
            body.innerHTML = '';
            const daysCount = new Date(2026, currentMonth + 1, 0).getDate();
            const weekNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

            for (let i = 1; i <= daysCount; i++) {
                const d = new Date(2026, currentMonth, i);
                const dayData = (fullYearData[currentMonth] && fullYearData[currentMonth][i]) || {open:"", shift:"", t20:"", close:""};
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-bold">${i}</td>
                    <td>${weekNames[d.getDay()]}</td>
                    <td contenteditable="true" class="editable" onblur="updateData(${i}, 'open', this.innerText)">${dayData.open || ""}</td>
                    <td contenteditable="true" class="editable" onblur="updateData(${i}, 'shift', this.innerText)">${dayData.shift || ""}</td>
                    <td contenteditable="true" class="editable" onblur="updateData(${i}, 't20', this.innerText)">${dayData.t20 || ""}</td>
                    <td contenteditable="true" class="editable" onblur="updateData(${i}, 'close', this.innerText)">${dayData.close || ""}</td>
                `;
                body.appendChild(tr);
            }
        }

        function updateData(day, field, val) {
            if(!fullYearData[currentMonth]) fullYearData[currentMonth] = {};
            if(!fullYearData[currentMonth][day]) fullYearData[currentMonth][day] = {};
            fullYearData[currentMonth][day][field] = val.trim();
            localStorage.setItem(storageKey, JSON.stringify(fullYearData));
        }

        function saveConfig() { localStorage.setItem('gas_url', document.getElementById('gasUrl').value); }

        function showDebug(msg, isError = true) {
            const box = document.getElementById('debugInfo');
            box.style.display = 'block';
            box.style.background = isError ? '#fee2e2' : '#f0fdf4';
            box.style.borderColor = isError ? '#ef4444' : '#22c55e';
            box.style.color = isError ? '#b91c1c' : '#15803d';
            box.innerText = msg;
        }

        async function testConnection() {
            const url = document.getElementById('gasUrl').value;
            if(!url) return showDebug("è«‹è¼¸å…¥ç¶²å€ï¼");
            showDebug("æ­£åœ¨æ¸¬è©¦é€£ç·š...", false);
            try {
                const res = await fetch(url);
                if(res.ok) {
                    showDebug("âœ… é€£ç·šæˆåŠŸï¼è©¦ç®—è¡¨ API å·²å°±ç·’ã€‚", false);
                } else {
                    showDebug("âŒ é€£ç·šå¤±æ•—ï¼šä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ (" + res.status + ")ã€‚è«‹æª¢æŸ¥éƒ¨ç½²æ˜¯å¦è¨­ç‚ºã€Œæ‰€æœ‰äººã€ã€‚");
                }
            } catch (e) {
                showDebug("âŒ ç„¡æ³•é€£æ¥ï¼šè«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢ºï¼Œä¸”çµå°¾ç‚º /execã€‚");
            }
        }

        async function syncToCloud() {
            const url = document.getElementById('gasUrl').value;
            showDebug("æ­£åœ¨å‚³é€è³‡æ–™...", false);
            try {
                // ä½¿ç”¨ POST å­˜æª”
                await fetch(url, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: "save", data: fullYearData })
                });
                showDebug("âœ… è³‡æ–™å·²ç™¼é€ï¼è«‹å»è©¦ç®—è¡¨æŸ¥çœ‹ã€‚è‹¥æ²’è®Šå‹•ï¼Œè«‹é‡æ–°éƒ¨ç½² GAS ä¸¦é¸ã€Œæ–°ç‰ˆæœ¬ã€ã€‚", false);
            } catch (e) {
                showDebug("âŒ å‚³é€å¤±æ•—ï¼š" + e.message);
            }
        }

        async function syncFromCloud() {
            const url = document.getElementById('gasUrl').value;
            showDebug("æ­£åœ¨æŠ“å–è³‡æ–™...", false);
            try {
                const res = await fetch(url);
                const data = await res.json();
                fullYearData = data;
                localStorage.setItem(storageKey, JSON.stringify(fullYearData));
                renderTable();
                showDebug("âœ… è¼‰å…¥æˆåŠŸï¼", false);
            } catch (e) {
                showDebug("âŒ è®€å–å¤±æ•—ã€‚è«‹ç¢ºèª GAS éƒ¨ç½²æ¬Šé™ç‚ºã€Œæ‰€æœ‰äººã€ã€‚");
            }
        }

        function changeMonth(v) { currentMonth = parseInt(v); renderTable(); }

        init();
    </script>
</body>
</html>